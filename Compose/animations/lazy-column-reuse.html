<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LazyColumn æ»šåŠ¨å¤ç”¨æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Monaco', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            background: #0f0f23;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid #333;
        }

        h2 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #00d9ff;
            border-radius: 2px;
        }

        /* æ¨¡æ‹Ÿæ‰‹æœºå±å¹• */
        .phone-frame {
            background: #0d1117;
            border-radius: 24px;
            padding: 10px;
            width: 250px;
            margin: 0 auto;
            border: 3px solid #333;
        }

        .phone-notch {
            width: 80px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin: 0 auto 10px;
        }

        .phone-screen {
            background: #1a1a2e;
            border-radius: 16px;
            height: 400px;
            overflow: hidden;
            position: relative;
        }

        .viewport-indicator {
            position: absolute;
            left: 0;
            right: 0;
            border: 2px dashed rgba(0, 217, 255, 0.5);
            background: rgba(0, 217, 255, 0.05);
            pointer-events: none;
            transition: top 0.3s ease, height 0.3s ease;
        }

        .list-container {
            position: relative;
            transition: transform 0.3s ease;
        }

        .list-item {
            height: 70px;
            margin: 8px;
            padding: 12px;
            border-radius: 10px;
            background: #0d1117;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .list-item.visible {
            border-color: #58d68d;
        }

        .list-item.entering {
            border-color: #5dade2;
            animation: slideIn 0.4s ease;
        }

        .list-item.exiting {
            border-color: #f5b041;
            opacity: 0.5;
        }

        .list-item.reused {
            border-color: #9b59b6;
            animation: reuseFlash 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes reuseFlash {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 15px rgba(155, 89, 182, 0.6); }
        }

        .item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5dade2, #3498db);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            font-size: 14px;
        }

        .item-content {
            flex: 1;
        }

        .item-title {
            font-size: 13px;
            color: #fff;
            margin-bottom: 4px;
        }

        .item-key {
            font-size: 10px;
            color: #888;
        }

        .item-key span {
            color: #00d9ff;
        }

        /* æ•°æ®é¢æ¿ */
        .data-section {
            margin-bottom: 20px;
        }

        .data-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .slot-mini {
            background: #0d1117;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            border-left: 3px solid #333;
            transition: all 0.3s ease;
        }

        .slot-mini.active {
            border-left-color: #58d68d;
        }

        .slot-mini.pool {
            border-left-color: #f5b041;
            opacity: 0.7;
        }

        .slot-mini.highlight {
            background: rgba(0, 217, 255, 0.1);
            border-left-color: #00d9ff;
        }

        .slot-mini-id {
            color: #00d9ff;
            font-weight: bold;
        }

        .slot-mini-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .slot-mini-status.visible {
            background: rgba(88, 214, 141, 0.2);
            color: #58d68d;
        }

        .slot-mini-status.pooled {
            background: rgba(245, 176, 65, 0.2);
            color: #f5b041;
        }

        /* æ»šåŠ¨æŒ‡ç¤ºå™¨ */
        .scroll-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #0d1117;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .scroll-info {
            font-size: 12px;
            color: #888;
        }

        .scroll-info span {
            color: #00d9ff;
            font-weight: bold;
        }

        .scroll-bar {
            width: 150px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .scroll-thumb {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #0099ff);
            border-radius: 4px;
            transition: width 0.3s ease, margin-left 0.3s ease;
        }

        /* æ—¥å¿—åŒº */
        .log-section {
            max-height: 200px;
            overflow-y: auto;
        }

        .log-item {
            font-size: 11px;
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-item.deactivate { background: rgba(245, 176, 65, 0.1); color: #f5b041; }
        .log-item.reuse { background: rgba(155, 89, 182, 0.1); color: #9b59b6; }
        .log-item.create { background: rgba(93, 173, 226, 0.1); color: #5dade2; }

        /* æ§åˆ¶åŒº */
        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff 0%, #0099ff 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: #333;
            color: #aaa;
        }

        .btn-secondary:hover {
            background: #444;
            color: #fff;
        }

        .btn-scroll {
            padding: 12px 24px;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* è¯´æ˜åŒº */
        .explanation {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            color: #aaa;
            line-height: 1.6;
        }

        .explanation strong {
            color: #00d9ff;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #0d1117;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        /* å›¾ä¾‹ */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #888;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.visible { background: #58d68d; }
        .legend-dot.entering { background: #5dade2; }
        .legend-dot.exiting { background: #f5b041; }
        .legend-dot.reused { background: #9b59b6; }
    </style>
</head>
<body>
    <div class="container">
        <h2>LazyColumn æ»šåŠ¨å¤ç”¨æ¼”ç¤º</h2>
        <p class="subtitle">æ¨¡æ‹Ÿåˆ—è¡¨æ»šåŠ¨æ—¶ Subcomposition çš„å¤ç”¨è¡Œä¸º</p>

        <div class="legend">
            <div class="legend-item"><div class="legend-dot visible"></div>å¯è§</div>
            <div class="legend-item"><div class="legend-dot entering"></div>è¿›å…¥è§†å£</div>
            <div class="legend-item"><div class="legend-dot exiting"></div>ç¦»å¼€è§†å£</div>
            <div class="legend-item"><div class="legend-dot reused"></div>è¢«å¤ç”¨</div>
        </div>

        <div class="main-layout">
            <!-- æ¨¡æ‹Ÿåˆ—è¡¨ -->
            <div class="panel">
                <div class="panel-title">LazyColumn æ¨¡æ‹Ÿ</div>
                <div class="phone-frame">
                    <div class="phone-notch"></div>
                    <div class="phone-screen" id="phone-screen">
                        <div class="list-container" id="list-container"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´æ•°æ®é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">Subcomposition çŠ¶æ€</div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-visible">5</div>
                        <div class="stat-label">å¯è§é¡¹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-pool">0</div>
                        <div class="stat-label">å¤ç”¨æ± </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-reuse">0</div>
                        <div class="stat-label">å¤ç”¨æ¬¡æ•°</div>
                    </div>
                </div>

                <div class="scroll-indicator">
                    <div class="scroll-info">
                        æ»šåŠ¨ä½ç½®: <span id="scroll-pos">0</span> / <span id="scroll-max">15</span>
                    </div>
                    <div class="scroll-bar">
                        <div class="scroll-thumb" id="scroll-thumb" style="width: 33%; margin-left: 0;"></div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="data-label">æ´»è·ƒçš„ Subcomposition</div>
                    <div id="active-slots"></div>
                </div>

                <div class="data-section">
                    <div class="data-label">å¤ç”¨æ± </div>
                    <div id="pool-slots"></div>
                </div>
            </div>

            <!-- æ—¥å¿—é¢æ¿ -->
            <div class="panel">
                <div class="panel-title">æ“ä½œæ—¥å¿—</div>
                <div class="log-section" id="log-section"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary btn-scroll" id="btn-up" disabled>â¬†ï¸ å‘ä¸Šæ»šåŠ¨</button>
            <button class="btn btn-primary btn-scroll" id="btn-down">â¬‡ï¸ å‘ä¸‹æ»šåŠ¨</button>
            <button class="btn btn-secondary" id="btn-reset">é‡ç½®</button>
        </div>

        <div class="explanation" id="explanation">
            <strong>ğŸ’¡ LazyColumn å¤ç”¨æœºåˆ¶</strong><br>
            å½“ç”¨æˆ·æ»šåŠ¨åˆ—è¡¨æ—¶ï¼Œç¦»å¼€è§†å£çš„ item ä¸ä¼šè¢«é”€æ¯ï¼Œè€Œæ˜¯æ”¾å…¥å¤ç”¨æ± ã€‚æ–°è¿›å…¥è§†å£çš„ item ä¼šä¼˜å…ˆä»å¤ç”¨æ± è·å– Subcomposition è¿›è¡Œå¤ç”¨ã€‚ç‚¹å‡»æ»šåŠ¨æŒ‰é’®è§‚å¯Ÿå¤ç”¨è¡Œä¸ºã€‚
        </div>
    </div>

    <script>
        // é…ç½®
        const TOTAL_ITEMS = 20;
        const VISIBLE_COUNT = 5;
        const ITEM_HEIGHT = 86; // 70 + 8*2
        const MAX_POOL_SIZE = 3;

        // çŠ¶æ€
        let scrollPosition = 0;
        let activeSlots = new Map();
        let poolSlots = [];
        let reuseCount = 0;

        // æ•°æ®
        const items = Array.from({ length: TOTAL_ITEMS }, (_, i) => ({
            id: i + 1,
            key: `user_${i + 1}`,
            name: `ç”¨æˆ· ${i + 1}`,
            avatar: String.fromCharCode(65 + (i % 26))
        }));

        function getVisibleRange() {
            return {
                start: scrollPosition,
                end: Math.min(scrollPosition + VISIBLE_COUNT, TOTAL_ITEMS)
            };
        }

        function addLog(type, message) {
            const logSection = document.getElementById('log-section');
            const icons = { deactivate: 'â¸ï¸', reuse: 'â™»ï¸', create: 'ğŸ†•' };
            const log = document.createElement('div');
            log.className = `log-item ${type}`;
            log.innerHTML = `<span>${icons[type]}</span>${message}`;
            logSection.insertBefore(log, logSection.firstChild);

            // ä¿æŒæ—¥å¿—æ•°é‡
            while (logSection.children.length > 20) {
                logSection.removeChild(logSection.lastChild);
            }
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const { start, end } = getVisibleRange();

            // æ¸²æŸ“æ‰€æœ‰é¡¹ç›®
            container.innerHTML = items.map((item, index) => {
                let statusClass = '';
                if (index >= start && index < end) {
                    if (activeSlots.get(item.key)?.isNew) {
                        statusClass = activeSlots.get(item.key)?.isReused ? 'reused' : 'entering';
                    } else {
                        statusClass = 'visible';
                    }
                } else if (index === start - 1 || index === end) {
                    statusClass = 'exiting';
                }

                return `
                    <div class="list-item ${statusClass}" style="opacity: ${index >= start && index < end ? 1 : 0.3}">
                        <div class="item-avatar">${item.avatar}</div>
                        <div class="item-content">
                            <div class="item-title">${item.name}</div>
                            <div class="item-key">key=<span>"${item.key}"</span></div>
                        </div>
                    </div>
                `;
            }).join('');

            // ç§»åŠ¨åˆ—è¡¨ä½ç½®
            container.style.transform = `translateY(${-scrollPosition * ITEM_HEIGHT}px)`;
        }

        function renderActiveSlots() {
            const container = document.getElementById('active-slots');
            const { start, end } = getVisibleRange();

            let html = '';
            for (let i = start; i < end; i++) {
                const item = items[i];
                const slot = activeSlots.get(item.key);
                html += `
                    <div class="slot-mini active ${slot?.isNew ? 'highlight' : ''}">
                        <span class="slot-mini-id">${item.key}</span>
                        <span class="slot-mini-status visible">${slot?.isReused ? 'å¤ç”¨' : 'æ´»è·ƒ'}</span>
                    </div>
                `;
            }
            container.innerHTML = html || '<div style="color:#555;font-size:11px;padding:10px;">æš‚æ— </div>';
        }

        function renderPoolSlots() {
            const container = document.getElementById('pool-slots');
            if (poolSlots.length === 0) {
                container.innerHTML = '<div style="color:#555;font-size:11px;padding:10px;">å¤ç”¨æ± ä¸ºç©º</div>';
                return;
            }

            container.innerHTML = poolSlots.map(key => `
                <div class="slot-mini pool">
                    <span class="slot-mini-id">${key}</span>
                    <span class="slot-mini-status pooled">ç¼“å­˜</span>
                </div>
            `).join('');
        }

        function updateStats() {
            const { start, end } = getVisibleRange();
            document.getElementById('stat-visible').textContent = end - start;
            document.getElementById('stat-pool').textContent = poolSlots.length;
            document.getElementById('stat-reuse').textContent = reuseCount;

            // æ»šåŠ¨æ¡
            document.getElementById('scroll-pos').textContent = scrollPosition;
            document.getElementById('scroll-max').textContent = TOTAL_ITEMS - VISIBLE_COUNT;

            const thumbWidth = (VISIBLE_COUNT / TOTAL_ITEMS) * 100;
            const thumbOffset = (scrollPosition / TOTAL_ITEMS) * 100;
            const thumb = document.getElementById('scroll-thumb');
            thumb.style.width = `${thumbWidth}%`;
            thumb.style.marginLeft = `${thumbOffset}%`;
        }

        function updateButtons() {
            document.getElementById('btn-up').disabled = scrollPosition <= 0;
            document.getElementById('btn-down').disabled = scrollPosition >= TOTAL_ITEMS - VISIBLE_COUNT;
        }

        function handleScroll(direction) {
            const oldStart = scrollPosition;
            const oldEnd = scrollPosition + VISIBLE_COUNT;

            if (direction === 'down' && scrollPosition < TOTAL_ITEMS - VISIBLE_COUNT) {
                scrollPosition++;
            } else if (direction === 'up' && scrollPosition > 0) {
                scrollPosition--;
            } else {
                return;
            }

            const newStart = scrollPosition;
            const newEnd = scrollPosition + VISIBLE_COUNT;

            // æ¸…é™¤æ‰€æœ‰ isNew æ ‡è®°
            activeSlots.forEach(slot => {
                slot.isNew = false;
                slot.isReused = false;
            });

            if (direction === 'down') {
                // ç¦»å¼€è§†å£çš„ item
                for (let i = oldStart; i < newStart; i++) {
                    const key = items[i].key;
                    if (activeSlots.has(key)) {
                        activeSlots.delete(key);

                        // æ”¾å…¥å¤ç”¨æ± 
                        if (poolSlots.length < MAX_POOL_SIZE) {
                            poolSlots.push(key);
                            addLog('deactivate', `${key} ç¦»å¼€è§†å£ï¼Œæ”¾å…¥å¤ç”¨æ± `);
                        } else {
                            // æ± æ»¡ï¼Œé‡Šæ”¾æœ€æ—©çš„
                            const disposed = poolSlots.shift();
                            poolSlots.push(key);
                            addLog('deactivate', `æ± æ»¡ï¼Œé‡Šæ”¾ ${disposed}ï¼Œ${key} å…¥æ± `);
                        }
                    }
                }

                // è¿›å…¥è§†å£çš„ item
                for (let i = oldEnd; i < newEnd; i++) {
                    const key = items[i].key;
                    let isReused = false;

                    // å°è¯•ä»æ± ä¸­å¤ç”¨
                    const poolIndex = poolSlots.indexOf(key);
                    if (poolIndex >= 0) {
                        poolSlots.splice(poolIndex, 1);
                        isReused = true;
                        reuseCount++;
                        addLog('reuse', `${key} è¿›å…¥è§†å£ï¼Œä»æ± ä¸­ç²¾ç¡®å¤ç”¨`);
                    } else if (poolSlots.length > 0) {
                        const reusedKey = poolSlots.shift();
                        isReused = true;
                        reuseCount++;
                        addLog('reuse', `${key} è¿›å…¥è§†å£ï¼Œå¤ç”¨ ${reusedKey}`);
                    } else {
                        addLog('create', `${key} è¿›å…¥è§†å£ï¼Œåˆ›å»ºæ–°çš„`);
                    }

                    activeSlots.set(key, { isNew: true, isReused });
                }
            } else {
                // å‘ä¸Šæ»šåŠ¨ - ç±»ä¼¼é€»è¾‘
                for (let i = newEnd; i < oldEnd; i++) {
                    const key = items[i].key;
                    if (activeSlots.has(key)) {
                        activeSlots.delete(key);
                        if (poolSlots.length < MAX_POOL_SIZE) {
                            poolSlots.push(key);
                            addLog('deactivate', `${key} ç¦»å¼€è§†å£ï¼Œæ”¾å…¥å¤ç”¨æ± `);
                        } else {
                            const disposed = poolSlots.shift();
                            poolSlots.push(key);
                            addLog('deactivate', `æ± æ»¡ï¼Œé‡Šæ”¾ ${disposed}ï¼Œ${key} å…¥æ± `);
                        }
                    }
                }

                for (let i = oldStart - 1; i >= newStart; i--) {
                    const key = items[i].key;
                    let isReused = false;

                    const poolIndex = poolSlots.indexOf(key);
                    if (poolIndex >= 0) {
                        poolSlots.splice(poolIndex, 1);
                        isReused = true;
                        reuseCount++;
                        addLog('reuse', `${key} è¿›å…¥è§†å£ï¼Œä»æ± ä¸­ç²¾ç¡®å¤ç”¨`);
                    } else if (poolSlots.length > 0) {
                        const reusedKey = poolSlots.shift();
                        isReused = true;
                        reuseCount++;
                        addLog('reuse', `${key} è¿›å…¥è§†å£ï¼Œå¤ç”¨ ${reusedKey}`);
                    } else {
                        addLog('create', `${key} è¿›å…¥è§†å£ï¼Œåˆ›å»ºæ–°çš„`);
                    }

                    activeSlots.set(key, { isNew: true, isReused });
                }
            }

            render();
        }

        function render() {
            renderList();
            renderActiveSlots();
            renderPoolSlots();
            updateStats();
            updateButtons();
        }

        function reset() {
            scrollPosition = 0;
            activeSlots.clear();
            poolSlots = [];
            reuseCount = 0;

            document.getElementById('log-section').innerHTML = '';

            // åˆå§‹åŒ–æ´»è·ƒ slots
            for (let i = 0; i < VISIBLE_COUNT; i++) {
                activeSlots.set(items[i].key, { isNew: false, isReused: false });
            }

            render();
            addLog('create', 'åˆå§‹åŒ–ï¼šæ˜¾ç¤º user_1 ~ user_5');
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('btn-down').addEventListener('click', () => handleScroll('down'));
        document.getElementById('btn-up').addEventListener('click', () => handleScroll('up'));
        document.getElementById('btn-reset').addEventListener('click', reset);

        // åˆå§‹åŒ–
        reset();
    </script>
</body>
</html>
